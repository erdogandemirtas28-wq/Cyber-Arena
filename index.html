<!DOCTYPE html>
<html>
<head>
    <title>Cyber Arena: Super Smooth</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; color: #0ff; }
        #overlay { position: fixed; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        input { padding: 15px; border: 2px solid #0ff; background: #000; color: #0ff; font-size: 1.2em; border-radius: 20px; outline: none; }
        button { margin-top: 15px; padding: 10px 40px; background: #0ff; border: none; cursor: pointer; font-weight: bold; border-radius: 20px; }
        #ui { position: fixed; top: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 15px; border: 1px solid #0ff; }
    </style>
</head>
<body>
    <div id="overlay">
        <h1>SIBER ARENA</h1>
        <input type="text" id="nameInp" placeholder="ADINIZI YAZIN" maxlength="12">
        <button id="startBtn">BAŞLA</button>
    </div>
    <div id="ui">ENERJİ: <span id="puan">0</span></div>
    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const socket = io();
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let state = { players: {}, foods: [], bullets: [] };
        let localPos = { x: 1500, y: 1500 }; 
        let mouseX = 0, mouseY = 0, isWPressed = false, isDPressed = false;

        window.onmousemove = (e) => { mouseX = e.clientX; mouseY = e.clientY; };
        window.onkeydown = (e) => { 
            if(e.key.toLowerCase() === 'w') isWPressed = true; 
            if(e.key.toLowerCase() === 'd') isDPressed = true;
        };
        window.onkeyup = (e) => { 
            if(e.key.toLowerCase() === 'w') isWPressed = false; 
            if(e.key.toLowerCase() === 'd') isDPressed = false;
        };
        window.onmousedown = () => {
            const me = state.players[socket.id];
            if(me && me.isAlive) socket.emit('fire', { angle: Math.atan2(mouseY - canvas.height/2, mouseX - canvas.width/2) });
        };

        document.getElementById('startBtn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            socket.emit('joinGame', document.getElementById('nameInp').value);
        };

        socket.on('updateState', (s) => {
            state = s;
            const me = state.players[socket.id];
            if (me && me.isAlive && Math.hypot(localPos.x - me.x, localPos.y - me.y) > 150) {
                localPos.x = me.x; localPos.y = me.y; // Sunucuyla çok fark varsa eşitle
            }
        });

        function gameLoop() {
            const me = state.players[socket.id];
            if (me && me.isAlive) {
                let dx = mouseX - canvas.width/2, dy = mouseY - canvas.height/2;
                let angle = Math.atan2(dy, dx);
                let speed = (isWPressed && me.score > 5) ? 12 : 5; // Hız artırıldı

                if (Math.hypot(dx, dy) > 20) {
                    localPos.x += Math.cos(angle) * speed;
                    localPos.y += Math.sin(angle) * speed;
                }
                
                // Sınırları koru
                localPos.x = Math.max(0, Math.min(3000, localPos.x));
                localPos.y = Math.max(0, Math.min(3000, localPos.y));

                socket.emit('move', { x: localPos.x, y: localPos.y, isShielded: isDPressed, isDashing: isWPressed, angle: angle });
                document.getElementById('puan').innerText = Math.floor(me.score);
            }

            ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (me) {
                ctx.save();
                ctx.translate(canvas.width/2 - localPos.x, canvas.height/2 - localPos.y);
                
                // Grid
                ctx.strokeStyle = "#112222"; ctx.lineWidth = 1;
                for(let i=0; i<=3000; i+=150) {
                    ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,3000); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(3000,i); ctx.stroke();
                }

                state.foods.forEach(f => {
                    ctx.beginPath(); ctx.arc(f.x, f.y, 8, 0, Math.PI*2);
                    ctx.fillStyle = f.type === 'gold' ? '#ffd700' : (f.type === 'poison' ? '#f00' : '#0ff');
                    ctx.fill();
                });

                for (let id in state.players) {
                    let p = state.players[id];
                    if (!p.isAlive) continue;
                    let drawX = (id === socket.id) ? localPos.x : p.x;
                    let drawY = (id === socket.id) ? localPos.y : p.y;

                    ctx.beginPath(); ctx.arc(drawX, drawY, p.radius, 0, Math.PI*2);
                    ctx.strokeStyle = p.color; ctx.lineWidth = 4; ctx.stroke();
                    ctx.fillStyle = p.color + "33"; ctx.fill();
                    
                    if(p.isShielded) {
                        ctx.beginPath(); ctx.arc(drawX, drawY, p.radius + 10, 0, Math.PI*2);
                        ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
                    }
                    ctx.fillStyle = "#fff"; ctx.textAlign = "center";
                    ctx.fillText(p.name, drawX, drawY - p.radius - 10);
                }
                ctx.restore();
            }
            requestAnimationFrame(gameLoop);
        }
        gameLoop();
    </script>
</body>
</html>