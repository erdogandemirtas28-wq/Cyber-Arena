<!DOCTYPE html>
<html>
<head>
    <title>Cyber Arena: Pro Edition</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; color: #0ff; }
        #overlay { position: fixed; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        input { padding: 12px; border: 2px solid #0ff; background: #000; color: #0ff; text-align: center; font-size: 1.2em; outline: none; }
        button { margin-top: 15px; padding: 10px 40px; background: #0ff; border: none; cursor: pointer; font-weight: bold; font-size: 1.2em; }
        #ui { position: fixed; top: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 12px; border: 1px solid #0ff; pointer-events: none; border-radius: 5px; }
        #controls-bar { position: fixed; bottom: 15px; width: 100%; text-align: center; color: #0ff; font-size: 0.9em; text-shadow: 0 0 5px #0ff; }
    </style>
</head>
<body>
    <div id="overlay">
        <h1>SIBER ARENA</h1>
        <input type="text" id="nameInp" placeholder="SİSTEM ADI" maxlength="12">
        <button id="startBtn">BAĞLAN</button>
    </div>
    
    <div id="ui">ENERJİ: <span id="puan">0</span></div>
    
    <div id="controls-bar">
        W: HIZLAN (TURBO) | D: KALKAN | SOL TIK: ATEŞ
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const socket = io();
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let state = { players: {}, foods: [], bullets: [] };
        let mouseX = 0, mouseY = 0, isWPressed = false, isDPressed = false;

        window.onmousemove = (e) => { mouseX = e.clientX; mouseY = e.clientY; };
        
        window.onkeydown = (e) => { 
            const key = e.key.toLowerCase();
            if(key === 'w') isWPressed = true; 
            if(key === 'd') isDPressed = true;
        };
        window.onkeyup = (e) => { 
            const key = e.key.toLowerCase();
            if(key === 'w') isWPressed = false; 
            if(key === 'd') isDPressed = false;
        };

        window.onmousedown = (e) => { if(e.button === 0) fire(); };

        document.getElementById('startBtn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            socket.emit('joinGame', document.getElementById('nameInp').value);
        };

        function fire() {
            const me = state.players[socket.id];
            if(me && me.isAlive) {
                let angle = Math.atan2(mouseY - canvas.height/2, mouseX - canvas.width/2);
                socket.emit('fire', { angle: angle });
            }
        }

        socket.on('updateState', (s) => state = s);

        function gameLoop() {
            const me = state.players[socket.id];
            if (me && me.isAlive) {
                let dx = mouseX - canvas.width/2;
                let dy = mouseY - canvas.height/2;
                let angle = Math.atan2(dy, dx);
                
                // Hız kontrolü: W basılıysa ve enerji varsa 8 birim, yoksa 3 birim hız
                let speed = (isWPressed && me.score > 10) ? 8 : 3;
                
                if (Math.hypot(dx, dy) > 15) {
                    me.x += Math.cos(angle) * speed;
                    me.y += Math.sin(angle) * speed;
                }

                // Sunucuya yeni konumumuzu bildiriyoruz
                socket.emit('move', { x: me.x, y: me.y, isShielded: isDPressed, isDashing: isWPressed, angle: angle });
                document.getElementById('puan').innerText = Math.floor(me.score);
            }

            ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (me) {
                ctx.save();
                ctx.translate(canvas.width/2 - me.x, canvas.height/2 - me.y);
                
                // Arka Plan Grid (Daha teknolojik görünüm)
                ctx.strokeStyle = "#0a2a2a"; ctx.lineWidth = 1;
                for(let i=0; i<=3000; i+=150) {
                    ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,3000); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(3000,i); ctx.stroke();
                }

                state.foods.forEach(f => {
                    ctx.beginPath(); ctx.arc(f.x, f.y, 6, 0, Math.PI*2);
                    ctx.fillStyle = f.type === 'gold' ? '#ffd700' : (f.type === 'poison' ? '#f0f' : '#0ff');
                    ctx.fill();
                });

                state.bullets.forEach(b => {
                    ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2);
                    ctx.fillStyle = "#fff"; ctx.fill();
                });

                for (let id in state.players) {
                    let p = state.players[id];
                    if (!p.isAlive) continue;
                    
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
                    ctx.strokeStyle = p.color; ctx.lineWidth = 3; ctx.stroke();
                    ctx.fillStyle = p.color + "33"; ctx.fill();
                    
                    if(p.isShielded) { 
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.radius + 8, 0, Math.PI*2); 
                        ctx.strokeStyle="#fff"; ctx.lineWidth = 2; ctx.stroke();
                    }
                    ctx.fillStyle = "#fff"; ctx.textAlign = "center";
                    ctx.fillText(p.name, p.x, p.y - p.radius - 10);
                }
                ctx.restore();
            }
            requestAnimationFrame(gameLoop);
        }
        gameLoop();
    </script>
</body>
</html>